#!/bin/bash
# OpenClaw Buttons CLI
# Command-line interface for managing OpenClaw Function Buttons

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="beta-1.1"
CHANNEL="beta"

echo -e "${BLUE}üéØ OpenClaw Function Buttons CLI v$VERSION${NC}"
echo "========================================"

# Check dependencies
check_deps() {
    if ! command -v jq >/dev/null 2>&1; then
        echo -e "${RED}‚ùå jq is required but not installed${NC}"
        echo "Install with: sudo apt install jq"
        exit 1
    fi
}

# Update command
update_command() {
    echo -e "\nüîÑ Checking for updates..."
    
    # Get latest version from GitHub
    LATEST_VERSION=$(curl -s "https://api.github.com/repos/AmandaHernow/openclaw-function-buttons/releases/latest" | jq -r '.tag_name // .name' 2>/dev/null)
    
    if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Could not check for updates${NC}"
        echo "Check your internet connection"
        return 1
    fi
    
    echo -e "Current version: ${GREEN}$VERSION${NC}"
    echo -e "Latest version:  ${GREEN}$LATEST_VERSION${NC}"
    
    if [ "$VERSION" != "$LATEST_VERSION" ]; then
        echo -e "\n${GREEN}üéâ Update available!${NC}"
        echo -e "Updating from $VERSION to $LATEST_VERSION"
        
        # Backup current installation
        echo -e "\nüì¶ Creating backup..."
        BACKUP_DIR="/tmp/openclaw-buttons-backup-$(date +%Y%m%d-%H%M%S)"
        mkdir -p "$BACKUP_DIR"
        cp -r "$PROJECT_DIR/library" "$BACKUP_DIR/" 2>/dev/null || true
        cp -r "$PROJECT_DIR/installer" "$BACKUP_DIR/" 2>/dev/null || true
        echo -e "Backup created: $BACKUP_DIR"
        
        # Download and extract update
        echo -e "\nüåê Downloading update..."
        TEMP_DIR=$(mktemp -d)
        cd "$TEMP_DIR"
        
        # Download latest release
        curl -L "https://github.com/AmandaHernow/openclaw-function-buttons/archive/refs/tags/$LATEST_VERSION.tar.gz" -o update.tar.gz 2>/dev/null
        
        if [ $? -eq 0 ]; then
            echo -e "‚úÖ Update downloaded"
            
            # Extract
            tar -xzf update.tar.gz
            EXTRACTED_DIR=$(find . -type d -name "openclaw-function-buttons-*" | head -1)
            
            if [ -n "$EXTRACTED_DIR" ]; then
                # Copy files
                echo -e "üìÅ Installing update..."
                cp -r "$EXTRACTED_DIR/library/" "$PROJECT_DIR/"
                cp -r "$EXTRACTED_DIR/installer/" "$PROJECT_DIR/"
                cp "$EXTRACTED_DIR/README.md" "$PROJECT_DIR/" 2>/dev/null || true
                cp "$EXTRACTED_DIR/channels.json" "$PROJECT_DIR/" 2>/dev/null || true
                
                echo -e "${GREEN}‚úÖ Update installed successfully!${NC}"
                echo -e "Restart any running button processes"
            else
                echo -e "${RED}‚ùå Failed to extract update${NC}"
            fi
            
            # Cleanup
            cd /
            rm -rf "$TEMP_DIR"
        else
            echo -e "${RED}‚ùå Failed to download update${NC}"
            cd /
            rm -rf "$TEMP_DIR"
        fi
    else
        echo -e "\n${GREEN}‚úÖ You're up to date!${NC}"
    fi
}

# Install command
install_command() {
    echo -e "\nüöÄ Running installer..."
    "$PROJECT_DIR/installer/one-command-setup.sh"
}

# Uninstall command
uninstall_command() {
    echo -e "\nüóëÔ∏è  Running uninstaller..."
    "$PROJECT_DIR/installer/uninstall.sh"
}

# Settings command
settings_command() {
    echo -e "\n‚öôÔ∏è  Opening Settings Manager..."
    "$PROJECT_DIR/library/settings-manager.sh"
}

# Update command (library button)
update_button_command() {
    echo -e "\nüîÑ Opening Update System..."
    "$PROJECT_DIR/library/update-system.sh"
}

# Help command
help_command() {
    echo -e "${BLUE}üìñ OpenClaw Buttons CLI Help${NC}"
    echo "========================"
    echo ""
    echo "Commands:"
    echo "  update       - Check for and install updates"
    echo "  install      - Run the interactive installer"
    echo "  uninstall    - Remove buttons from system"
    echo "  settings     - Open Settings Manager"
    echo "  update-btn   - Open Update System (library button)"
    echo "  help         - Show this help message"
    echo "  version      - Show version information"
    echo ""
    echo "Examples:"
    echo "  openclaw_buttons update"
    echo "  openclaw_buttons install"
    echo "  openclaw_buttons settings"
    echo ""
    echo "Channel: $CHANNEL"
    echo "Version: $VERSION"
}

# Version command
version_command() {
    echo -e "${BLUE}üìä Version Information${NC}"
    echo "-------------------"
    echo "OpenClaw Function Buttons"
    echo "Version: $VERSION"
    echo "Channel: $CHANNEL"
    echo "Project: https://github.com/AmandaHernow/openclaw-function-buttons"
    echo ""
    echo "Developed by: Amanda Hernow & Cleo Nightshade"
    echo "Purpose: One-click desktop buttons for OpenClaw"
    echo ""
    echo "Last updated: $(date -r "$PROJECT_DIR/README.md" '+%Y-%m-%d %H:%M:%S')"
}

# Main execution
check_deps

if [ $# -eq 0 ]; then
    help_command
    exit 0
fi

case $1 in
    "update")
        update_command
        ;;
    "install")
        install_command
        ;;
    "uninstall")
        uninstall_command
        ;;
    "settings")
        settings_command
        ;;
    "update-btn")
        update_button_command
        ;;
    "help")
        help_command
        ;;
    "version")
        version_command
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}"
        echo ""
        help_command
        exit 1
        ;;
esac

echo -e "\n${GREEN}‚ú® Command completed${NC}"